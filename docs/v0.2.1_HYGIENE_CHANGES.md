# Repository Hygiene Changes (v0.2.1)

**Date:** 2026-01-23
**Purpose:** Address repository hygiene issues and prepare for pip installability

## Changes Made

### 1. Root __init__.py Removal (HIGH PRIORITY)

**Problem:** Root-level `__init__.py` caused import ambiguity between package and workspace root.

**Action:**
- Deleted `__init__.py` at repository root
- Only `src/utils_cmip7/__init__.py` remains as package initializer

**Impact:** Eliminates import confusion, ensures `import utils_cmip7` always resolves to `src/utils_cmip7/`

**Verification:**
```bash
python -c "import utils_cmip7; print(utils_cmip7.__file__)"
# Should output: .../src/utils_cmip7/__init__.py
```

---

### 2. Test Consolidation (HIGH PRIORITY)

**Problem:** Test files split between `tests/` and root directory.

**Action:**
- Moved all `test_*.py` files from root to `tests/`
- Updated `pyproject.toml` pytest configuration:
  ```toml
  [tool.pytest.ini_options]
  testpaths = ["tests"]
  addopts = "-q"
  ```

**Files Moved:**
- `test_canonical_variables.py` → `tests/`
- `test_extraction_fix.py` → `tests/`
- `test_warnings_suppressed.py` → `tests/`
- `test_plot_fix.py` → `tests/`
- `test_tau_fix.py` → `tests/`

**Impact:** Clear test organization, easier pytest discovery

---

### 3. Documentation Standardization (MED-HIGH PRIORITY)

**Problem:** Both `doc/` and `docs/` directories existed.

**Action:**
- Moved all files from `doc/` to `docs/`
- Removed empty `doc/` directory
- Updated all references in `README.md` and `scripts/`

**Files Moved:**
- `doc/API_REFERENCE.md` → `docs/`
- `doc/TROUBLESHOOTING.md` → `docs/`
- `doc/MIGRATION.md` → `docs/`
- `doc/STASH.md` → `docs/`

**Impact:** Follows GitHub Pages convention, eliminates confusion

---

### 4. Validation Directory Rename (HIGH PRIORITY)

**Problem:** Top-level `validation/` (outputs) shadowed `src/utils_cmip7/validation/` (code) in Python import system.

**Action:**
- Renamed `validation/` → `validation_outputs/`
- Updated `scripts/validate_experiment.py`:
  - Line 13: Updated docstring path
  - Line 365: `outdir = Path('validation_outputs') / f'single_val_{expt}'`
- Updated all references in `README.md`

**Impact:** Eliminates dangerous import shadowing, clarifies intent (outputs vs code)

**Verification:**
```bash
python -c "import utils_cmip7.validation; print(utils_cmip7.validation.__file__)"
# Should output: .../src/utils_cmip7/validation/__init__.py
```

---

### 5. Package Data: obs/ → data/obs/ (HIGH PRIORITY)

**Problem:** Observational CSV files not installable via pip, hardcoded relative paths.

**Action:**

**A. Moved files:**
```bash
obs/ → src/utils_cmip7/data/obs/
```

**B. Updated `pyproject.toml`:**
```toml
[tool.setuptools]
package-dir = {"" = "src"}
include-package-data = true

[tool.setuptools.package-data]
utils_cmip7 = ["data/obs/*.csv"]
```

**C. Created `MANIFEST.in`:**
```
recursive-include src/utils_cmip7/data/obs *.csv
```

**D. Updated `src/utils_cmip7/io/obs_loader.py`:**
- Replaced relative path logic with `importlib.resources`
- Python 3.9+ uses `importlib.resources.files`
- Python 3.8 fallback to `importlib_resources`
- Development mode fallback to direct path

**New Implementation:**
```python
from importlib.resources import files

def get_obs_dir():
    """Get absolute path to obs/ directory using importlib.resources."""
    try:
        obs_path = files('utils_cmip7').joinpath('data/obs')
        return str(obs_path)
    except (TypeError, AttributeError):
        # Fallback for editable installs
        pkg_dir = os.path.dirname(os.path.dirname(__file__))
        obs_dir = os.path.join(pkg_dir, 'data', 'obs')
        if os.path.exists(obs_dir):
            return obs_dir
        raise FileNotFoundError(...)
```

**Impact:**
- CSV files ship with wheels/sdist
- Works in both development mode and pip installed mode
- No more "obs/ not found" errors after `pip install`

---

## Files Changed Summary

**Deleted:**
- `__init__.py` (root)
- `doc/` (entire directory)
- `obs/` (entire directory)
- `validation/` (renamed)
- Root test files (5 files)

**Created:**
- `MANIFEST.in`
- `verify_hygiene.py` (verification script)
- `docs/v0.2.1_HYGIENE_CHANGES.md` (this file)
- `src/utils_cmip7/data/obs/` (new location)
- `validation_outputs/` (renamed directory)

**Modified:**
- `pyproject.toml` (pytest config, package data)
- `src/utils_cmip7/io/obs_loader.py` (importlib.resources)
- `scripts/validate_experiment.py` (output paths)
- `README.md` (documentation references)

---

## Migration Impact

### Breaking Changes: NONE

All changes are **backward compatible** for existing users:
- Package imports unchanged (`import utils_cmip7`)
- API unchanged
- Script behavior unchanged (just different output directory names)

### Developer Impact: LOW

**If you have a local clone:**
```bash
git pull
rm -rf __init__.py  # If you have uncommitted local changes
```

**If you ran scripts before:**
- Old output: `validation/single_val_{expt}/`
- New output: `validation_outputs/single_val_{expt}/`
- No need to update existing results

---

## Verification

Run the verification script in your Python environment:

```bash
python verify_hygiene.py
```

Expected output:
```
======================================================================
Repository Hygiene Verification
======================================================================

Directory Structure:
✓ docs/ directory exists
✓ tests/ directory exists
✓ validation_outputs/ directory exists
✓ obs/ moved to package data
✓ doc/ correctly removed
✓ obs/ correctly moved
✓ validation/ correctly renamed

Root __init__.py Removal:
✓ Root __init__.py correctly removed

Package Import:
✓ Package imports correctly from: .../src/utils_cmip7/__init__.py

Validation Module:
✓ Validation module imports correctly from: .../src/utils_cmip7/validation/__init__.py

Obs Loader:
✓ obs_loader found data at: .../src/utils_cmip7/data/obs
  ✓ All 4 CSV files present

======================================================================
Summary
======================================================================
✓ PASS: Directory Structure
✓ PASS: Root __init__.py Removal
✓ PASS: Package Import
✓ PASS: Validation Module
✓ PASS: Obs Loader
======================================================================
Result: 5/5 tests passed
======================================================================

✅ All repository hygiene changes verified!
```

---

## Next Steps (v0.3.0 Roadmap)

These hygiene changes address the "high impact" items from the review. Remaining items:

1. **Canonical Metric Contract (HIGH):**
   - Implement typed `MetricSpec` registry
   - Replace `CANONICAL_VARIABLES` dict with dataclass-based system
   - Enforce SUM/MEAN from metadata only

2. **Scientific Correctness (HIGH):**
   - Document GPP/NPP flux handling (monthly means vs accumulated totals)
   - Clarify Tau definition (soil-only vs ecosystem-wide)
   - Add unit-aware time integration

3. **CLI Implementation (MED-HIGH):**
   - Implement `utils-cmip7 extract-annual`
   - Implement `utils-cmip7 metrics`
   - Implement `utils-cmip7 validate`

4. **Dependency Split (MED):**
   - core dependencies (numpy, pandas, xarray)
   - plotting dependencies (matplotlib, cartopy)
   - validation dependencies (scipy)
   - dev dependencies (pytest, mypy, black)

---

## Technical Notes

### importlib.resources Compatibility

The `obs_loader.py` implementation handles three scenarios:

1. **Installed package (Python 3.9+):**
   ```python
   from importlib.resources import files
   obs_path = files('utils_cmip7').joinpath('data/obs')
   ```

2. **Installed package (Python 3.8):**
   ```python
   from importlib_resources import files  # backport
   ```

3. **Editable install / development:**
   ```python
   pkg_dir = os.path.dirname(os.path.dirname(__file__))
   obs_dir = os.path.join(pkg_dir, 'data', 'obs')
   ```

This ensures the package works in all common installation modes.

### pytest Configuration

Simplified from coverage-heavy to minimal for faster iteration:

**Old:**
```toml
addopts = "-v --cov=utils_cmip7 --cov-report=html --cov-report=term"
```

**New:**
```toml
addopts = "-q"
```

Coverage can be run explicitly when needed: `pytest --cov=utils_cmip7`

---

## References

- User review: See conversation context for full technical review
- CLAUDE.md: Architectural constraints (rule #7: no non-deterministic iteration)
- pyproject.toml: Package configuration
- verify_hygiene.py: Automated verification script
