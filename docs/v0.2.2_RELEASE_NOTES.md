# v0.2.2 Release Notes

**Release Date:** 2025-01-25
**Status:** Complete

---

## Summary

v0.2.2 completes the medium-priority tasks from the MIGRATION.md roadmap, including CLI implementation, plotting refactor, and comprehensive documentation. This release focuses on improving developer experience and package usability.

---

## What's New

### 1. Command-Line Interface (CLI)

Two new CLI entry points for data extraction:

```bash
# Extract from preprocessed annual means
utils-cmip7-extract-preprocessed xqhuc --base-dir ~/annual_mean

# Extract from raw monthly files
utils-cmip7-extract-raw xqhuj --start-year 2000 --end-year 2010
```

**Features:**
- Flexible output (CSV or stdout)
- Region and variable filtering
- Year range selection for raw extraction
- Comprehensive help documentation

**Implementation:**
- New module: `src/utils_cmip7/cli.py`
- Entry points registered in `pyproject.toml`
- Full argument parsing with argparse
- Graceful error handling

---

### 2. Plotting Module Refactor

Plotting functions migrated from legacy `plot.py` to structured package:

```
plotting/
├── timeseries.py   # Time series plots
├── spatial.py      # Regional/spatial plots
├── styles.py       # Styling utilities
├── ppe_viz.py      # PPE validation (existing)
└── ppe_param_viz.py  # Parameter analysis (existing)
```

**New Feature:** All plotting functions now accept `ax` parameter for custom axes:

```python
import matplotlib.pyplot as plt
from utils_cmip7.plotting import plot_timeseries_grouped

# Use custom axes
fig, axes = plt.subplots(2, 3)
plot_timeseries_grouped(data, ['exp1'], 'global', ax=axes)
```

**Functions Migrated:**
- `plot_timeseries_grouped()` → `timeseries.py`
- `plot_pft_timeseries()` → `timeseries.py`
- `plot_regional_pie()` → `spatial.py`
- `plot_regional_pies()` → `spatial.py`
- `plot_pft_grouped_bars()` → `spatial.py`
- `group_vars_by_prefix()` → `styles.py`

**Backward Compatibility:**
- Root `plot.py` wrapper maintained with deprecation warnings
- Existing scripts continue to work
- Gradual migration path available

---

### 3. Soil Parameters Review

**Decision:** Current location (`src/utils_cmip7/soil_params/`) is appropriate.

**Rationale:**
- Soil parameters are configuration/metadata, not diagnostics
- Used in validation workflow, not computation
- Standalone concern deserves top-level module
- Already migrated from root in v0.2.1.1

**Legacy Files:**
- `soil_params_io.py`, `soil_params_figures.py`, `soil_params_maps.py` remain at root
- These are specialized analysis utilities, not core package functionality
- Can be integrated or deprecated in future releases

---

### 4. Documentation

#### New Documents

**MIGRATION_GUIDE.md**
- Quick reference table (old → new imports)
- Step-by-step migration instructions
- Version-specific upgrade guides
- Common issues and solutions
- Backward compatibility timeline

**v0.2.2_RELEASE_NOTES.md**
- This document

#### Updated Documents

**API_REFERENCE.md**
- Updated package structure diagram
- Updated status markers (all modules now complete)
- Added CLI documentation
- Added plotting module documentation
- Updated version history

**MIGRATION.md**
- v0.2.2 tasks marked complete in implementation timeline

---

## Breaking Changes

**None.** This release is fully backward-compatible.

**Deprecation Warnings:**
- Importing from `plot` triggers deprecation warning
- Users encouraged to migrate to `utils_cmip7.plotting`

---

## Files Created/Modified

### New Files Created (11)
1. `src/utils_cmip7/cli.py` - CLI implementation
2. `src/utils_cmip7/plotting/timeseries.py` - Time series plots
3. `src/utils_cmip7/plotting/spatial.py` - Spatial plots
4. `src/utils_cmip7/plotting/styles.py` - Styling utilities
5. `docs/MIGRATION_GUIDE.md` - Migration documentation
6. `docs/v0.2.2_RELEASE_NOTES.md` - This file
7. `tests/test_soil_params_parser.py` - Soil param tests (from v0.2.1.1)
8. `tests/test_overview_upsert.py` - Overview table tests (from v0.2.1.1)

### Files Modified (3)
1. `src/utils_cmip7/plotting/__init__.py` - Added new module exports
2. `plot.py` - Updated to import from new locations
3. `docs/API_REFERENCE.md` - Added CLI and plotting documentation

---

## Completion Criteria

All v0.2.2 tasks from MIGRATION.md completed:

- ✅ **Plotting Refactor**
  - Split into timeseries.py, spatial.py, styles.py
  - All functions accept Axes objects

- ✅ **CLI Implementation**
  - CLI wrappers for extraction functions
  - --help documentation
  - Entry points registered in pyproject.toml

- ✅ **Soil Parameters**
  - Reviewed location (current location appropriate)
  - No migration needed

- ✅ **Documentation**
  - Created migration examples
  - Updated API_REFERENCE.md
  - Added troubleshooting in MIGRATION_GUIDE.md

---

## Testing Status

### Manual Testing Required

Before tagging the release, test:

1. **CLI Commands:**
   ```bash
   utils-cmip7-extract-preprocessed --help
   utils-cmip7-extract-raw --help
   ```

2. **Plotting Functions:**
   ```python
   from utils_cmip7.plotting import plot_timeseries_grouped
   # Verify both with and without ax parameter
   ```

3. **Backward Compatibility:**
   ```python
   from plot import plot_timeseries_grouped  # Should work with warning
   ```

### Unit Tests

- ✅ test_soil_params_parser.py (7 tests)
- ✅ test_overview_upsert.py (7 tests)
- ⚠️ CLI tests - To be added in CI setup
- ⚠️ Plotting tests - Smoke tests only (future enhancement)

---

## Next Steps (v0.3.0)

From MIGRATION.md, the next phase is **API Stabilization and CI**:

### High Priority
1. **Testing & CI**
   - Add unit tests for I/O, processing, diagnostics
   - Set up GitHub Actions
   - Add coverage tracking
   - Python 3.8-3.11 matrix testing

2. **API Freeze**
   - Review all public APIs
   - Mark stable vs provisional
   - Lock public API at v0.3.0

3. **Documentation Polish**
   - Add example datasets
   - Create tutorial notebooks
   - Improve error messages

### Medium Priority
1. **Performance Profiling**
   - Identify bottlenecks
   - Optimize hot paths
   - Add performance benchmarks

2. **Code Quality**
   - Add type hints
   - Remove commented-out code
   - Linting with flake8/mypy

---

## Contributors

- Claude Sonnet 4.5 (AI Assistant)
- Yousheng Li (Project Maintainer)

---

## Acknowledgments

This release completes the v0.2.2 roadmap as defined in docs/MIGRATION.md. Special thanks to the architectural planning that made this systematic refactor possible.

---

Last updated: 2025-01-25
